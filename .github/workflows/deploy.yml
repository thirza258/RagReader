name: Build and Deploy 

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix Docker DNS
        run: |
          sudo mkdir -p /etc/docker
          echo '{"dns":["8.8.8.8","1.1.1.1"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Increase Docker timeouts
        run: |
          echo "DOCKER_CLIENT_TIMEOUT=300" >> $GITHUB_ENV
          echo "COMPOSE_HTTP_TIMEOUT=300" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3


      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ragreader-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ragreader-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install cloudflared
        run: |
          curl -L -o cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy to server
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -o ProxyCommand="/usr/bin/cloudflared access ssh --hostname %h --id ${{ secrets.CF_CLIENT_ID }} --secret ${{ secrets.CF_CLIENT_SECRET }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'

          set -e
          mkdir -p ~/rag_app
          cd ~/rag_app

          echo "DEBUG=false" > .env
          echo "DEVELOPMENT_MODE=false" >> .env

          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_PORT=5432" >> .env

          echo "BACKEND_PORT=${{ secrets.BACKEND_PORT }}" >> .env

          echo "DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/${{ secrets.DB_NAME }}" >> .env

          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "OPEN_ROUTER_KEY=${{ secrets.OPEN_ROUTER_KEY }}" >> .env

          echo "LANGSMITH_TRACING=false" >> .env
          echo "LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" >> .env
          echo "LANGSMITH_ENDPOINT=${{ secrets.LANGSMITH_ENDPOINT }}" >> .env
          echo "LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }}" >> .env

          mkdir -p frontend
          echo "VITE_API_URL=http://backend:${{ secrets.BACKEND_PORT }}" > frontend/.env
          echo "VITE_API_VERSION=v1" >> frontend/.env

          cat <<COMPOSE > docker-compose.prod.yml
          services:
            postgres:
              image: postgres:16-alpine
              container_name: rag_postgres
              environment:
                POSTGRES_DB: \${DB_NAME}
                POSTGRES_USER: \${DB_USER}
                POSTGRES_PASSWORD: \${DB_PASSWORD}
              volumes:
                - postgres_data:/var/lib/postgresql/data
              restart: unless-stopped

            redis:
              image: redis:7-alpine
              container_name: rag_redis
              restart: unless-stopped

            vector_db:
              image: chromadb/chroma
              container_name: rag_vectordb
              volumes:
                - vectorstore:/chroma/chroma
              restart: unless-stopped

            backend:
              image: ${{ secrets.DOCKER_USERNAME }}/ragreader-backend:latest
              command: daphne
              container_name: rag_backend
              env_file: .env
              depends_on:
                - postgres
                - redis
                - vector_db
              ports:
                - "\${BACKEND_PORT}:\${BACKEND_PORT}"
              restart: unless-stopped

            worker:
              image: ${{ secrets.DOCKER_USERNAME }}/ragreader-backend:latest
              container_name: rag_worker
              command: celery -A ragreader worker -l info
              env_file: .env
              depends_on:
                - redis
                - postgres
              restart: unless-stopped

            frontend:
              image: ${{ secrets.DOCKER_USERNAME }}/ragreader-frontend:latest
              container_name: rag_frontend
              ports:
                - "5176:5176"
              depends_on:
                - backend
              restart: unless-stopped

          volumes:
            postgres_data:
            vectorstore:
          COMPOSE

          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml up -d --remove-orphans
          docker image prune -f

          EOF
