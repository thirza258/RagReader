name: Build and Deploy 

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile-backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ragreader-backend:latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: Dockerfile-frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ragreader-frontend:latest

      - name: Install cloudflared
        run: |
          curl -L -o cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy to server
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh \
            -o StrictHostKeyChecking=no \
            -o ProxyCommand="/usr/bin/cloudflared access ssh --hostname %h --id ${{ secrets.CF_CLIENT_ID }} --secret ${{ secrets.CF_CLIENT_SECRET }}" \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'

          set -e
          mkdir -p ~/rag_app
          cd ~/rag_app

          cat <<ENV > .env
          DEBUG=false
          DEVELOPMENT_MODE=false

          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=5432

          BACKEND_PORT=${{ secrets.BACKEND_PORT }}

          DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/${{ secrets.DB_NAME }}

          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPEN_ROUTER_KEY=${{ secrets.OPEN_ROUTER_KEY }}

          LANGSMITH_TRACING=false
          ENV

          mkdir -p frontend
          cat <<ENV > frontend/.env
          VITE_API_URL=http://backend:${{ secrets.BACKEND_PORT }}
          VITE_API_VERSION=v1
          ENV

          cat <<COMPOSE > docker-compose.prod.yml
          services:
            postgres:
              image: postgres:16-alpine
              container_name: rag_postgres
              environment:
                POSTGRES_DB: \${DB_NAME}
                POSTGRES_USER: \${DB_USER}
                POSTGRES_PASSWORD: \${DB_PASSWORD}
              volumes:
                - postgres_data:/var/lib/postgresql/data
              restart: unless-stopped

            redis:
              image: redis:7-alpine
              container_name: rag_redis
              restart: unless-stopped

            vector_db:
              image: chromadb/chroma
              container_name: rag_vectordb
              volumes:
                - vectorstore:/chroma/chroma
              restart: unless-stopped

            backend:
              image: ${{ secrets.DOCKER_USERNAME }}/ragreader-backend:latest
              command: daphne
              container_name: rag_backend
              env_file: .env
              depends_on:
                - postgres
                - redis
                - vector_db
              ports:
                - "${BACKEND_PORT}:${BACKEND_PORT}"
              restart: unless-stopped

            worker:
              image: ${{ secrets.DOCKER_USERNAME }}/ragreader-backend:latest
              container_name: rag_worker
              command: celery -A ragreader worker -l info
              env_file: .env
              depends_on:
                - redis
                - postgres
              restart: unless-stopped

            frontend:
              image: ${{ secrets.DOCKER_USERNAME }}/ragreader-frontend:latest
              container_name: rag_frontend
              ports:
                - "5176:5176"
              depends_on:
                - backend
              restart: unless-stopped

          volumes:
            postgres_data:
            vectorstore:
          COMPOSE

          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml up -d --remove-orphans
          docker image prune -f

          EOF
